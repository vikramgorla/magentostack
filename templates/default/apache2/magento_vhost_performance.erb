<%- if @params[:ssl] %>
<VirtualHost *:<%= @params[:https_port] %>>

  SSLEngine on
  SSLCertificateFile <%= @params[:ssl_cert] %>

  <% if @params[:ssl_chain] %>SSLCertificateChainFile <%= @params[:ssl_chain] %><% end %>
  SSLCertificateKeyFile <%= @params[:ssl_key] %>
  <%- else %>
  <VirtualHost *:<%= @params[:http_port] %>>
  <%- end %>

  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] %>ServerAlias <%= @params[:server_aliases] %><% end %>
  DocumentRoot <%= @params[:docroot] %>
  DirectoryIndex index.php

  # We are enabling this even if we are not behind a load-balancer as it should not create any harm
  SetEnvIf X-Forwarded-Proto https HTTPS=on

  <Directory <%= @params[:docroot] %>/>
    Options +FollowSymLinks
    EnableMMAP <%= @params[:apache]['enable_mmap'] %>
    EnableSendfile <%= @params[:apache]['enable_sendfile'] %>
    
    <% if @params[:apache]['basic_username'] %>
        <% if @params[:apache]['allow_from'] %>
            Satisfy Any
        <% end %>
    AuthUserFile <%= @params[:apache]['htpasswd'] %>
    AuthType Basic
    AuthName "Protected System"
    Require valid-user
    
    <% end  %>

    <% if @params[:apache]['parse_htaccess'] %>
    AllowOverride All
    <% else %>
    ## Apache optimisation by disabling the .htaccess parsing
    ## Directives for securing directorys have been added to this file
    AllowOverride None
    <% end %>
    Order allow,deny
    <% if @params[:apache]['allow_from'] %>
        <% @params[:apache]['allow_from'].each do |ip| %>
            Allow from <%= ip %>
        <% end %>
    <% else %>
        Allow from all
    <% end %>
    
    DirectoryIndex index.php
    
    <IfModule mod_php5.c>

        ############################################
        ## disable magic quotes for php request vars

        php_flag magic_quotes_gpc off

        ############################################
        ## disable automatic session start
        ## before autoload was initialized

        php_flag session.auto_start off

        php_flag session.gc_maxlifetime 3600

        ############################################
        ## enable resulting html compression

        #php_flag zlib.output_compression on

        ###########################################
        # disable user agent verification to not break multiple image upload

        php_flag suhosin.session.cryptua off

        ###########################################
        # turn off compatibility with PHP4 when dealing with objects

        php_flag zend.ze1_compatibility_mode Off

    </IfModule>
    
    <IfModule mod_security.c>
        ###########################################
        # disable POST processing to not break multiple image upload

        SecFilterEngine Off
        SecFilterScanPOST Off
    </IfModule>
    
    <IfModule mod_deflate.c>

        ############################################
        ## enable apache served files compression
        ## http://developer.yahoo.com/performance/rules.html#gzip

        # Insert filter on all content
        ###SetOutputFilter DEFLATE
        # Insert filter on selected content types only
        AddOutputFilterByType DEFLATE text/css application/x-javascript text/javascript text/x-component text/html text/richtext image/svg+xml text/plain text/xsd text/xsl text/xml image/x-icon
        #
        # Netscape 4.x has some problems...
        BrowserMatch ^Mozilla/4 gzip-only-text/html

        # Netscape 4.06-4.08 have some more problems
        BrowserMatch ^Mozilla/4\.0[678] no-gzip

        # MSIE masquerades as Netscape, but it is fine
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html

        # Don't compress images
        SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary

        # Make sure proxies don't deliver the wrong content
        Header append Vary User-Agent env=!dont-vary

    </IfModule>
    
    <IfModule mod_ssl.c>

        ############################################
        ## make HTTPS env vars available for CGI mode

        SSLOptions StdEnvVars

    </IfModule>
    
    <IfModule mod_rewrite.c>

        ############################################
        ## enable rewrites

        Options +FollowSymLinks
        RewriteEngine on

        ############################################
        ## you can put here your magento root folder
        ## path relative to web root

        #RewriteBase /

        RewriteRule ^server-status - [L]

        ############################################
        ## workaround for HTTP authorization
        ## in CGI environment

        RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

        ############################################
        ## always send 404 on missing files in these folders

        RewriteCond %{REQUEST_URI} !^/(media|skin|js)/

        ############################################
        ## never rewrite for existing files, directories and links

        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_FILENAME} !-l

        ############################################
        ## rewrite everything else to index.php

        RewriteRule .* index.php [L]

    </IfModule>
    
    AddType application/x-font-woff woff

    <IfModule mod_expires.c>
        ExpiresActive on
        ExpiresByType image/jpg "access plus 6 months"
        ExpiresByType image/png "access plus 6 months"
        ExpiresByType image/jpeg "access plus 6 months"
        ExpiresByType image/gif "access plus 6 months"
        ExpiresByType image/png "access plus 6 months"
        ExpiresByType text/plain "access plus 6 months"
        ExpiresByType text/ico "access plus 6 months"
        ExpiresByType image/ico "access plus 6 months"
        ExpiresByType image/icon "access plus 6 months"
        ExpiresByType image/x-icon "access plus 6 months"
        ExpiresByType application/x-font-woff "access plus 6 months"
        ExpiresByType application/x-shockwave-flash "modification plus 6 months"
        ExpiresByType text/css "access plus 1 week"
        ExpiresByType text/javascript "access plus 1 week"
        ExpiresByType text/xml "modification plus 2 hours"
        ExpiresByType image/vnd.microsoft.icon "access plus 6 months"
    </IfModule>

    <IfModule mod_headers.c>
        Header append Vary User-Agent env=!dont-vary

        <FilesMatch "\.(ico|jpe?g|png|gif|swf|css|gz|js|woff)$">
            Header set Cache-Control  "public, max-age=2592000"
        </FilesMatch>

    </IfModule>

    ############################################
    ## Prevent character encoding issues from server overrides
    ## If you still have problems, use the second line instead

    AddDefaultCharset Off
    #AddDefaultCharset UTF-8

    ############################################
    ## If running in cluster environment, uncomment this
    ## http://developer.yahoo.com/performance/rules.html#etags

    FileETag none
    # FileETag MTime Size
        <%- if @params[:ssl] %>SSLRequire %{SSL_CIPHER_USEKEYSIZE} >= 128<%- end %>
    <IfModule mod_deflate.c>
      SetOutputFilter DEFLATE
      BrowserMatch ^Mozilla/4 gzip-only-text/html
      BrowserMatch ^Mozilla/4\.0[678] no-gzip
      BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
      SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
      Header append Vary User-Agent env=!dont-vary
    </IfModule>
    <ifModule mod_expires.c>
      ExpiresActive On
      ExpiresDefault "access plus 1 month"
    </IfModule>
    # Allow web fonts across parallel hostnames
    # (otherwise Firefox and IE won't load them from CSS)
    <FilesMatch "\.(ttf|otf|eot|svg|woff)$">
        <IfModule mod_headers.c>
           Header set Access-Control-Allow-Origin "*"
        </IfModule>
    </FilesMatch>
    
  </Directory>
  <%
    [
      '/app',
      '/dev',
      '/downloader',
      '~ ^/error/.*\.(xml|phtml)$',
      '/includes',
      '/lib',
      '/media/downloadable',
      '/shell',
      '/skin/frontend/rwd/default/scss',
      '/frontend/rwd/enterprise/scss',
      '/var',
      '/.gitignore',
      '/composer.json',
      '/cron.php',
      '/cron.sh',
      '/index.php.sample',
      '/install.php',
      '/mage',
      '/php.ini.sample',
      '/RELEASE_NOTES.txt',
      '/README.txt',
      '/errors/default/404.phtml',
      '/errors/default/503.phtml',
      '/errors/default/page.phtml',
      '/errors/default/report.phtml',
      '/errors/design.xml',
      '/errors/local.xml'
    ].each do |dir| %>
  <Location <%= dir %>>
      Order deny,allow
      Deny from all
  </Location>
  <% end %>
  
  <Directory <%= @params[:docroot] %>/media>
      Options All -Indexes
      <IfModule mod_php5.c>
      php_flag engine 0
      </IfModule>

      AddHandler cgi-script .php .pl .py .jsp .asp .htm .shtml .sh .cgi
      Options -ExecCGI

      <IfModule mod_rewrite.c>

          ############################################
          ## enable rewrites

          Options +FollowSymLinks
          RewriteEngine on

          ############################################
          ## never rewrite for existing files
          RewriteCond %{REQUEST_FILENAME} !-f

          ############################################
          ## rewrite everything else to index.php

          RewriteRule .* ../get.php [L]
      </IfModule>
  </Directory>
  
  <Directory <%= @params[:docroot] %>/staging>
          AllowOverride All
          Order allow,deny
          Allow from all
  </Directory>
  
  <Directory />
    Options FollowSymLinks
    AllowOverride All
  </Directory>
  

  #Log settings
  CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:server_name] %>-<% if @params[:ssl] %>ssl_<% end %>access_log combined
  ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:server_name] %>-<% if @params[:ssl] %>ssl_<% end %>error_log
  
  # Disable Server Siganture for security reasons
  ServerSignature Off

  <Location /server-status>
    SetHandler server-status

    <% if node['apache']['version'] == '2.2' -%>
    Order Deny,Allow
    Deny from all
    Allow from 127.0.0.1
    <% elsif node['apache']['version'] == '2.4' -%>
    Require host 127.0.0.1
    <% end -%>
  </Location>

  # hide .git and .git+ (gitignore, gitmodules, etc)
  # do not allow .git version control files to be issued
  <DirectoryMatch "^/.*/\.git+/">
    Order deny,allow
    Deny from all
  </DirectoryMatch>
  <Files ~ "^\.git">
      Order allow,deny
      Deny from all
  </Files>

  # also hide .svn directories
  <DirectoryMatch \.svn>
    Order allow,deny
    Deny from all
  </DirectoryMatch>

</VirtualHost>
